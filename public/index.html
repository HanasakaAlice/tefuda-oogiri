<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>æ‰‹æœ­å¤§å–œåˆ©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="/socket.io/socket.io.js"></script>

  <style>
    :root {
      --bg: #1f130f;
      --bg-soft: #2b1a13;
      --panel: rgba(255, 247, 236, 0.96);
      --accent: #b5733b;
      --accent-soft: #e8c5a3;
      --accent-dark: #704020;
      --text-main: #3c2415;
      --text-soft: #6d5140;
      --border-soft: rgba(0,0,0,0.08);
      --card-bg: #fff7ec;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      background: radial-gradient(circle at top, #3b2314 0, #1c0f08 50%, #0c0603 100%);
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 16px;
    }

    .container {
      width: 100%;
      max-width: 1080px;
      background: linear-gradient(135deg, rgba(255,255,255,0.96), rgba(255,248,235,0.96));
      border-radius: 24px;
      box-shadow:
        0 24px 60px rgba(0,0,0,0.45),
        0 0 0 1px rgba(255,255,255,0.35);
      padding: 20px 20px 16px;
      position: relative;
      overflow: hidden;
    }

    .container::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 0% 0%, rgba(255,255,255,0.25), transparent 60%),
        radial-gradient(circle at 100% 0%, rgba(255,194,120,0.25), transparent 55%);
      opacity: 0.7;
      pointer-events: none;
    }

    .inner {
      position: relative;
      z-index: 1;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .title-block {
      display: flex;
      align-items: baseline;
      gap: 8px;
    }

    h1 {
      margin: 0;
      font-size: 26px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--accent-dark);
    }

    .subtitle {
      font-size: 12px;
      color: var(--text-soft);
    }

    .badge-phase {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: var(--accent-soft);
      color: var(--accent-dark);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.16);
    }

    .badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 3px rgba(181, 115, 59, 0.25);
    }

    main {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 14px;
    }

    @media (max-width: 800px) {
      main {
        grid-template-columns: 1fr;
      }
    }

    .section {
      background: rgba(255,255,255,0.9);
      border-radius: 18px;
      padding: 12px 14px;
      margin-bottom: 10px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }

    .section h2 {
      margin: 0 0 6px;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--accent-dark);
    }

    .section h2::before {
      content: "";
      width: 8px;
      height: 18px;
      border-radius: 999px;
      background: linear-gradient(180deg, var(--accent), var(--accent-dark));
      opacity: 0.9;
    }

    .section p {
      margin: 3px 0 8px;
      font-size: 13px;
      color: var(--text-soft);
    }

    .field-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
    }

    input[type="text"] {
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid #d1c3b7;
      width: 100%;
      font-size: 13px;
      outline: none;
      background: #fffdf8;
    }
    input[type="text"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(181,115,59,0.25);
    }

    button {
      padding: 7px 14px;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      color: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.18);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition:
        transform 0.08s ease,
        box-shadow 0.08s ease,
        filter 0.08s ease;
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.28);
      filter: brightness(1.03);
    }

    button:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 0 3px 8px rgba(0,0,0,0.18);
      filter: brightness(0.96);
    }

    button:disabled {
      opacity: 0.45;
      cursor: default;
      box-shadow: none;
      filter: grayscale(0.1);
    }

    .btn-ghost {
      background: transparent;
      color: var(--accent-dark);
      box-shadow: none;
      border: 1px solid rgba(181,115,59,0.4);
    }
    .btn-ghost:hover:not(:disabled) {
      background: rgba(255,248,237,0.9);
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .error {
      color: #c0392b;
      margin-top: 3px;
      font-size: 12px;
    }

    .small {
      font-size: 11px;
      color: var(--text-soft);
    }

    #player-list {
      list-style: none;
      padding-left: 0;
      margin: 6px 0 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .player-chip {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
      background: #fffaf2;
      border-radius: 999px;
      padding: 4px 8px;
      border: 1px solid rgba(0,0,0,0.03);
    }

    .player-left {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .avatar {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      background: var(--accent-soft);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: var(--accent-dark);
      font-weight: 600;
    }

    .tag {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(0,0,0,0.04);
      color: var(--text-soft);
    }

    #game-section {
      border-radius: 18px;
    }

    #phase-title {
      margin: 0 0 4px;
      font-size: 18px;
      color: var(--accent-dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #phase-info {
      margin: 0 0 10px;
    }

    .score-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #fffaf2;
      margin-bottom: 3px;
    }

    .score-row.me {
      background: #fbe7cc;
      font-weight: 500;
    }

    .score-name {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .score-badge {
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 999px;
      background: rgba(0,0,0,0.06);
      color: var(--text-soft);
    }

    #prompt-section {
      margin: 6px 0 10px;
      padding: 8px 10px;
      border-radius: 14px;
      background: #fff8ec;
      border: 1px dashed rgba(181,115,59,0.4);
    }

    .prompt {
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 4px;
    }

    .prompt-label {
      font-size: 11px;
      color: var(--text-soft);
    }

    .cards-wrapper-title {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
    }

    .winner-result {
    font-size: 3.6em;
    font-weight: 700;
    color: #d63a3a;
    margin-top: 6px;
    margin-bottom: 6px;
    }


    .cards-title {
      font-size: 14px;
      margin: 0;
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
    }

    .card {
      border-radius: 14px;
      padding: 9px 10px 10px;
      background: var(--card-bg);
      box-shadow:
        0 3px 8px rgba(0,0,0,0.12),
        0 0 0 1px rgba(0,0,0,0.02);
      cursor: pointer;
      font-size: 13px;
      line-height: 1.4;
      position: relative;
      overflow: hidden;
      transition:
        transform 0.05s ease,
        box-shadow 0.05s ease,
        background 0.08s ease,
        opacity 0.08s ease;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top left, rgba(255,255,255,0.5), transparent 55%);
      opacity: 0;
      transition: opacity 0.15s ease;
      pointer-events: none;
    }

    .card:hover {
      transform: translateY(-1px);
      box-shadow:
        0 6px 15px rgba(0,0,0,0.16),
        0 0 0 1px rgba(181,115,59,0.28);
      background: #fffaf1;
    }

    .card:hover::before {
      opacity: 0.7;
    }

    .card.disabled {
      opacity: 0.55;
      cursor: default;
      box-shadow:
        0 1px 3px rgba(0,0,0,0.06),
        0 0 0 1px rgba(0,0,0,0.02);
      transform: none;
    }

    .card.disabled::before {
      opacity: 0;
    }

    .card-label {
      position: absolute;
      top: 6px;
      right: 8px;
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(0,0,0,0.06);
      color: var(--text-soft);
    }

    .card.my-submission {
      background: #e6f3ff;
      box-shadow:
        0 4px 10px rgba(0, 0, 0, 0.12),
        0 0 0 1px rgba(80, 130, 200, 0.35);
    }

    .card.voted-by-me {
      background: #ffe8e8;
      box-shadow:
        0 4px 10px rgba(0, 0, 0, 0.12),
        0 0 0 1px rgba(210, 80, 80, 0.4);
    }

    #result-section, #gameover-section {
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px dashed rgba(0,0,0,0.12);
    }

    #result-section h3,
    #gameover-section h3 {
      margin: 0 0 4px;
      font-size: 14px;
      color: var(--accent-dark);
    }

    #result-list > div,
    #gameover-list > div {
      font-size: 13px;
      margin-top: 3px;
    }

    #game-error {
      margin-top: 6px;
      min-height: 16px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="inner">
      <header>
        <div class="title-block">
          <h1>æ‰‹æœ­å¤§å–œåˆ©</h1>
          <div class="subtitle">Card-based Online Oogiri Party</div>
        </div>
        <div class="badge-phase">
          <div class="badge-dot"></div>
          <span id="phase-badge-text">å¾…æ©Ÿä¸­</span>
        </div>
      </header>

      <main>
        <!-- å·¦ã‚«ãƒ©ãƒ ï¼šå‚åŠ  & ãƒ­ãƒ“ãƒ¼ -->
        <div>
          <!-- å‚åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
          <div class="section" id="join-section">
            <h2>å‚åŠ ã™ã‚‹</h2>
            <p>åå‰ã‚’å…¥åŠ›ã—ã¦ã€éƒ¨å±‹ã«å…¥ã‚Šã¾ã™ã€‚</p>
            <div class="field-row">
              <input type="text" id="name-input" placeholder="åå‰ï¼ˆæœªå…¥åŠ›ã§ã‚‚OKï¼‰" />
            </div>
            <div class="field-row">
              <button id="join-button">
                å‚åŠ ã™ã‚‹
              </button>
            </div>
            <div id="join-error" class="error"></div>
          </div>

          <!-- ãƒ­ãƒ“ãƒ¼è¡¨ç¤º -->
<div class="section" id="lobby-section" style="display:none;">
  <h2>ãƒ­ãƒ“ãƒ¼</h2>
  <p id="lobby-info"></p>
  <ul id="player-list"></ul>

           <!-- â˜… ãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
          <div style="margin-top:8px;">
            <div class="small">ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰</div>
            <select id="mode-select">
              <option value="draft">ã‚«ãƒ¼ãƒ‰ãƒ‰ãƒ©ãƒ•ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆ2æšã‹ã‚‰é¸ã‚“ã§æ‰‹æœ­ã‚’ä½œã‚‹ï¼‰</option>
              <option value="custom">è‡ªä½œæ‰‹æœ­ãƒ¢ãƒ¼ãƒ‰ï¼ˆè‡ªåˆ†ã§5å€‹ã®å›ç­”ã‚’è€ƒãˆã‚‹ï¼‰</option>
            </select>
            <div class="small" id="mode-info" style="margin-top:4px;">
              ãƒ›ã‚¹ãƒˆãŒãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¾ã™ã€‚
            </div>
          </div>

          <div style="margin-top:8px; display:flex; gap:6px; align-items:center;">
            <button id="start-button" disabled>ã‚²ãƒ¼ãƒ é–‹å§‹ï¼ˆãƒ›ã‚¹ãƒˆï¼‰</button>
          </div>
          <div class="small" style="margin-top:4px;">
            â€» æœ€ä½2äººã‹ã‚‰é–‹å§‹ã§ãã¾ã™ã€‚æœ€å¤§4äººã¾ã§ã€‚
          </div>
        </div>
        </div>

        <!-- å³ã‚«ãƒ©ãƒ ï¼šã‚¹ã‚³ã‚¢ & å›ç­”ã‚¨ãƒªã‚¢ -->
        <div>
          <!-- ã‚¹ã‚³ã‚¢å°‚ç”¨ãƒœãƒƒã‚¯ã‚¹ -->
          <div class="section" id="score-section" style="display:none;">
            <h2>ã‚¹ã‚³ã‚¢</h2>
            <div id="score-list"></div>
          </div>

          <!-- å›ç­”ã‚¨ãƒªã‚¢ -->
          <div class="section" id="game-section" style="display:none;">
            <h2 id="phase-title">ã‚²ãƒ¼ãƒ </h2>
            <div id="phase-info" class="small"></div>

            <!-- æ‰‹æœ­ãƒ‰ãƒ©ãƒ•ãƒˆãƒ•ã‚§ãƒ¼ã‚º -->
            <div id="draft-section" style="display:none;">
            <div class="cards-wrapper-title">
                <h3 class="cards-title">
                æ‰‹æœ­æ§‹ç¯‰ï¼ˆã‚ã¨ <span id="draft-remaining-count"></span> æšï¼‰
                </h3>
                <div class="small">2æšã®ã‚«ãƒ¼ãƒ‰ã‹ã‚‰1æšã‚’é¸ã‚“ã§æ‰‹æœ­ã«åŠ ãˆã¾ã™ã€‚</div>
            </div>
            <div id="draft-cards" class="card-grid"></div>
            </div>


            <div id="prompt-section">
              <div class="prompt" id="prompt-text">ã¾ã ã‚²ãƒ¼ãƒ ã¯é–‹å§‹ã—ã¦ã„ã¾ã›ã‚“ã€‚</div>
              <div class="prompt-label">ãŠé¡ŒãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
            </div>

            <!-- è‡ªä½œæ‰‹æœ­ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼šæ‰‹æœ­å…¥åŠ›ãƒ•ã‚§ãƒ¼ã‚º -->
            <div id="manual-hand-section" style="display:none;">
              <div class="cards-wrapper-title">
                <h3 class="cards-title">æ‰‹æœ­ã‚’ä½œæˆ</h3>
                <div class="small">å¤§å–œåˆ©ã®å›ç­”ã‚’5ã¤å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆå„ãƒ©ã‚¦ãƒ³ãƒ‰ã§ä½¿ã‚ã‚Œã¾ã™ï¼‰ã€‚</div>
              </div>
              <div id="manual-hand-inputs">
                <textarea class="manual-hand-input" rows="2" placeholder="å›ç­”1"></textarea>
                <textarea class="manual-hand-input" rows="2" placeholder="å›ç­”2"></textarea>
                <textarea class="manual-hand-input" rows="2" placeholder="å›ç­”3"></textarea>
                <textarea class="manual-hand-input" rows="2" placeholder="å›ç­”4"></textarea>
                <textarea class="manual-hand-input" rows="2" placeholder="å›ç­”5"></textarea>
              </div>
              <div style="margin-top:6px;">
                <button id="submit-hand-button">æ‰‹æœ­ã‚’ç¢ºå®šã™ã‚‹</button>
              </div>
              <div id="manual-hand-message" class="small" style="margin-top:4px;"></div>
            </div>


            <!-- å›ç­”é¸æŠãƒ•ã‚§ãƒ¼ã‚º -->
            <div id="hand-section" style="display:none;">
              <div class="cards-wrapper-title">
                <h3 class="cards-title">æ‰‹æœ­ï¼ˆ1æšé¸ã‚“ã§å‡ºã™ï¼‰</h3>
                <div class="small">ã‚¿ãƒƒãƒ— / ã‚¯ãƒªãƒƒã‚¯ã§æå‡º</div>
              </div>
              <div id="hand-cards" class="card-grid"></div>
            </div>

            <!-- æŠ•ç¥¨ãƒ•ã‚§ãƒ¼ã‚º -->
            <div id="vote-section" style="display:none;">
              <div class="cards-wrapper-title">
                <h3 class="cards-title">æŠ•ç¥¨ï¼ˆ1æšé¸ã‚“ã§æŠ•ç¥¨ï¼‰</h3>
                <div class="small">è‡ªåˆ†ã®ã‚«ãƒ¼ãƒ‰ã«ã¯æŠ•ç¥¨ã§ãã¾ã›ã‚“</div>
              </div>
              <div id="vote-cards" class="card-grid"></div>
            </div>

                        <!-- ãƒ©ã‚¦ãƒ³ãƒ‰çµæœ -->
            <div id="result-section" style="display:none;">
            <h3>ãƒ©ã‚¦ãƒ³ãƒ‰çµæœ</h3>
            <div id="result-list"></div>
            <div style="margin-top:8px;">
                <button id="next-round-button" class="btn-ghost">æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¸</button>
                <div id="next-round-wait" class="small" style="margin-top:4px; display:none;">
                ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å¾…ã£ã¦ã„ã¾ã™â€¦
                </div>
            </div>
            </div>


            <!-- ã‚²ãƒ¼ãƒ çµ‚äº† -->
            <div id="gameover-section" style="display:none;">
              <h3>æœ€çµ‚çµæœ</h3>
              <div id="gameover-list"></div>
              <div style="margin-top:8px;">
                <button id="restart-button" class="btn-ghost">ã‚‚ã†ä¸€å›éŠã¶ï¼ˆãƒ›ã‚¹ãƒˆã®ã¿ï¼‰</button>
              </div>
            </div>

            <div id="game-error" class="error"></div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    const socket = io();

    let myPlayerId = null;
    let hostId = null;
    let currentPhase = 'waiting';
    let hasPlayedThisRound = false;
    let hasVotedThisRound = false;
    let myVotedSubmissionId = null;

    const joinSection = document.getElementById('join-section');
    const joinButton = document.getElementById('join-button');
    const nameInput = document.getElementById('name-input');
    const joinError = document.getElementById('join-error');

    const lobbySection = document.getElementById('lobby-section');
    const lobbyInfo = document.getElementById('lobby-info');
    const playerList = document.getElementById('player-list');
    const startButton = document.getElementById('start-button');

    const modeSelect = document.getElementById('mode-select');
    const modeInfo = document.getElementById('mode-info');

    const manualHandSection = document.getElementById('manual-hand-section');
    const manualHandInputs = document.querySelectorAll('.manual-hand-input');
    const submitHandButton = document.getElementById('submit-hand-button');
    const manualHandMessage = document.getElementById('manual-hand-message');

    let currentGameMode = 'draft';  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ

    modeSelect.addEventListener('change', () => {
      currentGameMode = modeSelect.value;
    });


    const draftSection = document.getElementById('draft-section');
    const draftCards = document.getElementById('draft-cards');
    const draftRemainingCount = document.getElementById('draft-remaining-count');

    const nextRoundButton = document.getElementById('next-round-button');
    const nextRoundWait = document.getElementById('next-round-wait');



    const scoreSection = document.getElementById('score-section');
    const gameSection = document.getElementById('game-section');
    const phaseTitle = document.getElementById('phase-title');
    const phaseInfo = document.getElementById('phase-info');
    const scoreList = document.getElementById('score-list');
    const promptText = document.getElementById('prompt-text');
    const phaseBadgeText = document.getElementById('phase-badge-text');

    const handSection = document.getElementById('hand-section');
    const handCards = document.getElementById('hand-cards');

    const voteSection = document.getElementById('vote-section');
    const voteCards = document.getElementById('vote-cards');

    const resultSection = document.getElementById('result-section');
    const resultList = document.getElementById('result-list');

    const gameoverSection = document.getElementById('gameover-section');
    const gameoverList = document.getElementById('gameover-list');

    const gameError = document.getElementById('game-error');
    const restartButton = document.getElementById('restart-button');

    function updatePhaseBadge(label) {
      phaseBadgeText.textContent = label;
    }

    function setPhase(title, info, badgeLabel) {
      phaseTitle.textContent = title;
      phaseInfo.textContent = info || '';
      if (badgeLabel) updatePhaseBadge(badgeLabel);
    }

    function initialsFromName(name) {
      if (!name) return '?';
      const trimmed = name.trim();
      if (!trimmed) return '?';
      return trimmed[0];
    }

    function renderScores(scores) {
      scoreList.innerHTML = '';
      scores.forEach(s => {
        const row = document.createElement('div');
        row.className = 'score-row';
        if (s.id === myPlayerId) row.classList.add('me');

        const left = document.createElement('div');
        left.className = 'score-name';
        const nameSpan = document.createElement('span');
        nameSpan.textContent = s.name;
        left.appendChild(nameSpan);

        if (s.id === hostId) {
          const tag = document.createElement('span');
          tag.className = 'score-badge';
          tag.textContent = 'ãƒ›ã‚¹ãƒˆ';
          left.appendChild(tag);
        }
        if (s.id === myPlayerId) {
          const tagMe = document.createElement('span');
          tagMe.className = 'score-badge';
          tagMe.textContent = 'ã‚ãªãŸ';
          left.appendChild(tagMe);
        }

        const right = document.createElement('div');
        right.textContent = `${s.score} ç‚¹`;

        row.appendChild(left);
        row.appendChild(right);
        scoreList.appendChild(row);
      });
    }

    function showHand(hand) {
      handSection.style.display = 'block';
      voteSection.style.display = 'none';
      resultSection.style.display = 'none';
      gameoverSection.style.display = 'none';
      gameError.textContent = '';

      handCards.innerHTML = '';
      hand.forEach((cardText, index) => {
        const div = document.createElement('div');
        div.className = 'card';
        div.textContent = cardText;

        if (hasPlayedThisRound) {
          div.classList.add('disabled');
        } else {
          div.addEventListener('click', () => {
            if (hasPlayedThisRound) return;
            if (!confirm(`ã“ã®ã‚«ãƒ¼ãƒ‰ã‚’å‡ºã—ã¾ã™ã‹ï¼Ÿ\n\n${cardText}`)) return;
            socket.emit('playCard', { cardIndex: index });
          });
        }
        handCards.appendChild(div);
      });
    }

    function showDraftOptions(data) {
    // ãƒ‰ãƒ©ãƒ•ãƒˆç”»é¢è¡¨ç¤º
    draftSection.style.display = 'block';
    handSection.style.display = 'none';
    voteSection.style.display = 'none';
    resultSection.style.display = 'none';
    gameoverSection.style.display = 'none';
    document.getElementById('prompt-section').style.display = 'none';
    gameError.textContent = '';

    const remaining = data.totalPicks - data.picksDone;
    draftRemainingCount.textContent = remaining;

    draftCards.innerHTML = '';
    data.options.forEach((text, index) => {
        const div = document.createElement('div');
        div.className = 'card';
        div.textContent = text;

        div.addEventListener('click', () => {
        if (!confirm(`ã“ã®ã‚«ãƒ¼ãƒ‰ã‚’æ‰‹æœ­ã«åŠ ãˆã¾ã™ã‹ï¼Ÿ\n\n${text}`)) return;
        socket.emit('pickDraftCard', { choiceIndex: index });

        // é¸ã‚“ã å¾Œã¯ã€ä¸€æ—¦å…¨éƒ¨ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆ
        const cards = draftCards.querySelectorAll('.card');
        cards.forEach(c => c.classList.add('disabled'));
        });

        draftCards.appendChild(div);
    });
    }


  function showVoteCards(submissions) {
    handSection.style.display = 'none';
    voteSection.style.display = 'block';
    resultSection.style.display = 'none';
    gameoverSection.style.display = 'none';
    gameError.textContent = '';

    voteCards.innerHTML = '';
    submissions.forEach(sub => {
      const div = document.createElement('div');
      div.className = 'card';
      div.textContent = sub.text;

      // è‡ªåˆ†ã®ã‚«ãƒ¼ãƒ‰ã¯æ°´è‰²ã§è¡¨ç¤ºã—ã¦ã€ã‚¯ãƒªãƒƒã‚¯ä¸å¯ã«ã™ã‚‹
      if (sub.isMine) {
        div.classList.add('my-submission');
        div.classList.add('disabled');       // â† ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆï¼ˆé¸ã¹ãªã„ï¼‰
      } else {
        // ã™ã§ã«è‡ªåˆ†ãŒã“ã®ã‚«ãƒ¼ãƒ‰ã«æŠ•ç¥¨æ¸ˆã¿ãªã‚‰èµ¤ã
        if (myVotedSubmissionId && myVotedSubmissionId === sub.submissionId) {
          div.classList.add('voted-by-me');
        }

        if (hasVotedThisRound) {
          // ã‚‚ã†ä»–ã®ã‚«ãƒ¼ãƒ‰ã«æŠ•ç¥¨æ¸ˆã¿ãªã‚‰è§¦ã‚Œãªã„
          div.classList.add('disabled');
        } else {
          div.addEventListener('click', () => {
            if (hasVotedThisRound) return;
            if (!confirm(`ã“ã®å›ç­”ã«æŠ•ç¥¨ã—ã¾ã™ã‹ï¼Ÿ\n\n${sub.text}`)) return;

            // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®çŠ¶æ…‹æ›´æ–°
            myVotedSubmissionId = sub.submissionId;
            hasVotedThisRound = true;

            // ã‚µãƒ¼ãƒã«æŠ•ç¥¨ã‚’é€ä¿¡
            socket.emit('castVote', { submissionId: sub.submissionId });

            // è¦‹ãŸç›®ã‚’æ›´æ–°ï¼šè‡ªåˆ†ãŒé¸ã‚“ã ã‚«ãƒ¼ãƒ‰ã ã‘èµ¤ã€ãã®ã»ã‹ã¯ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆ
            const cards = voteCards.querySelectorAll('.card');
            cards.forEach(c => {
              if (c.textContent.trim() === sub.text.trim()) {
                c.classList.add('voted-by-me');
              } else {
                c.classList.add('disabled');
              }
            });
          });
        }
      }

      voteCards.appendChild(div);
    });
  }




    function showRoundResult(data) {
    handSection.style.display = 'none';
    voteSection.style.display = 'none';
    resultSection.style.display = 'block';
    gameoverSection.style.display = 'none';

    resultList.innerHTML = '';

    const intro = document.createElement('div');
    intro.textContent = `ç¬¬${data.round}ãƒ©ã‚¦ãƒ³ãƒ‰ã®çµæœï¼š`;
    resultList.appendChild(intro);

    // â˜… å¾—ç¥¨æ•°ã®æœ€å¤§å€¤ã‚’èª¿ã¹ã‚‹
    const maxVotes = Math.max(...data.results.map(r => r.votes));

    data.results.forEach(r => {
        const div = document.createElement('div');

        // ä¸€ä½ã‚’å¼·èª¿ã™ã‚‹
        if (r.votes === maxVotes && maxVotes > 0) {
        div.className = 'winner-result';
        div.textContent = `ğŸ†ã€Œ${r.text}ã€ by ${r.ownerName} â€¦â€¦ ${r.votes}ç¥¨`;
        } else {
        div.textContent = `ã€Œ${r.text}ã€ by ${r.ownerName} â€¦â€¦ ${r.votes}ç¥¨`;
        }

        resultList.appendChild(div);
    });

    // â˜… æœ€çµ‚ãƒ©ã‚¦ãƒ³ãƒ‰ã‹ã©ã†ã‹ã§ã€Œæ¬¡ãƒ©ã‚¦ãƒ³ãƒ‰ã¸ã€ãƒœã‚¿ãƒ³ã®åˆ¶å¾¡
    if (data.isLastRound) {
        nextRoundButton.style.display = 'none';
        nextRoundWait.style.display = 'none';
    } else {
        nextRoundButton.style.display = 'inline-flex';
        nextRoundButton.disabled = false;
        nextRoundWait.style.display = 'none';
    }
    }



    function showGameOver(data) {
      handSection.style.display = 'none';
      voteSection.style.display = 'none';
      resultSection.style.display = 'none';
      gameoverSection.style.display = 'block';

      gameoverList.innerHTML = '';
      data.scores.forEach((s, idx) => {
        const div = document.createElement('div');
        div.textContent = `${idx + 1}ä½ï¼š${s.name}ï¼ˆ${s.score}ç‚¹ï¼‰`;
        gameoverList.appendChild(div);
      });
    }

    joinButton.addEventListener('click', () => {
      joinError.textContent = '';
      const name = nameInput.value.trim();
      socket.emit('joinGame', { name });
    });

    startButton.addEventListener('click', () => {
      socket.emit('startGame', { mode: currentGameMode });
    });

    submitHandButton.addEventListener('click', () => {
      const answers = [];
      manualHandInputs.forEach(ta => {
        answers.push(ta.value);
      });

      // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã‚‚ã–ã£ãã‚Šãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      const trimmed = answers.map(a => a.trim());
      if (trimmed.some(t => t.length === 0)) {
        manualHandMessage.textContent = 'ç©ºæ¬„ã®å›ç­”ãŒã‚ã‚Šã¾ã™ã€‚ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        return;
      }

      submitHandButton.disabled = true;
      manualHandMessage.textContent = 'æ‰‹æœ­ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å¾…ã£ã¦ã„ã¾ã™â€¦';

      socket.emit('submitInitialHand', { answers: trimmed });
    });



    restartButton.addEventListener('click', () => {
      socket.emit('restartGame');
    });

    nextRoundButton.addEventListener('click', () => {
    nextRoundButton.disabled = true;
    nextRoundWait.style.display = 'block';
    socket.emit('readyNextRound');
    });



    socket.on('joined', data => {
      myPlayerId = data.playerId;
      joinSection.style.display = 'none';
      lobbySection.style.display = 'block';
      scoreSection.style.display = 'block';
      gameSection.style.display = 'block';
      setPhase('ãƒ­ãƒ“ãƒ¼', 'ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å¾…ã£ã¦ã„ã¾ã™ã€‚', 'ãƒ­ãƒ“ãƒ¼');
    });

    socket.on('lobbyUpdate', data => {
      hostId = data.hostId;
      currentPhase = data.gamePhase;

      playerList.innerHTML = '';
      data.players.forEach(p => {
        const li = document.createElement('li');
        const chip = document.createElement('div');
        chip.className = 'player-chip';

        const left = document.createElement('div');
        left.className = 'player-left';

        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.textContent = initialsFromName(p.name);

        const nameSpan = document.createElement('span');
        nameSpan.textContent = p.name;

        left.appendChild(avatar);
        left.appendChild(nameSpan);

        const right = document.createElement('div');
        if (p.id === hostId) {
          const tag = document.createElement('span');
          tag.className = 'tag';
          tag.textContent = 'ãƒ›ã‚¹ãƒˆ';
          right.appendChild(tag);
        }
        if (p.id === myPlayerId) {
          const tagMe = document.createElement('span');
          tagMe.className = 'tag';
          tagMe.textContent = 'ã‚ãªãŸ';
          right.appendChild(tagMe);
        }

        chip.appendChild(left);
        chip.appendChild(right);
        li.appendChild(chip);
        playerList.appendChild(li);
      });

      lobbyInfo.textContent = `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼äººæ•°ï¼š${data.players.length} / ${data.maxPlayers}`;

      if (myPlayerId && myPlayerId === hostId && data.gamePhase === 'waiting') {
        startButton.disabled = data.players.length < 2;
      } else {
        startButton.disabled = true;
      }

      // â˜… ã“ã“ã§ã‚²ãƒ¼ãƒ ãƒ•ã‚§ãƒ¼ã‚ºã”ã¨ã®ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
      if (data.gamePhase === 'waiting') {
        // ãƒ­ãƒ“ãƒ¼ã«æˆ»ã™
        lobbySection.style.display = 'block';
        gameSection.style.display = 'none';
        gameoverSection.style.display = 'none';

        updatePhaseBadge('å¾…æ©Ÿä¸­');
      } else {
        // ã‚²ãƒ¼ãƒ ä¸­ãƒ•ã‚§ãƒ¼ã‚ºã®å ´åˆï¼ˆãŠå¥½ã¿ã§ï¼‰
        lobbySection.style.display = 'none';
        gameSection.style.display = 'block';
      }
    });

    // ã‚µãƒ¼ãƒã‹ã‚‰ã€Œ2æšã®å€™è£œã€ãŒé€ã‚‰ã‚Œã¦ããŸã¨ã
socket.on('draftOptions', data => {
  currentPhase = 'draft';
  setPhase(
    'æ‰‹æœ­æ§‹ç¯‰',
    '2æšã®ã‚«ãƒ¼ãƒ‰ã‹ã‚‰1æšã‚’é¸ã‚“ã§ã€æ‰‹æœ­ã‚’5æšä½œã‚Šã¾ã™ã€‚',
    `æ‰‹æœ­æ§‹ç¯‰ ${data.picksDone + 1}/${data.totalPicks}`
  );
  showDraftOptions(data);
});

// 1æšé¸ã³çµ‚ã‚ã£ãŸã¨ãï¼ˆã‚µãƒ¼ãƒã‹ã‚‰ã®ç¢ºèªï¼‰
    socket.on('draftPicked', data => {
    const remaining = data.totalPicks - data.picksDone;
    if (remaining > 0) {
        setPhase(
        'æ‰‹æœ­æ§‹ç¯‰',
        `ã‚ã¨${remaining}æšé¸ã¶ã¨ã‚²ãƒ¼ãƒ é–‹å§‹ã§ã™ã€‚`,
        `æ‰‹æœ­æ§‹ç¯‰ ${data.picksDone + 1}/${data.totalPicks}`
        );
    } else {
        setPhase(
        'ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å¾…æ©Ÿä¸­',
        'å…¨å“¡ã®æ‰‹æœ­æº–å‚™ãŒçµ‚ã‚ã‚‹ã¨ã‚²ãƒ¼ãƒ ãŒå§‹ã¾ã‚Šã¾ã™ã€‚',
        'æ‰‹æœ­æ§‹ç¯‰å®Œäº†'
        );
        // è‡ªåˆ†ã¯5æšé¸ã³ãã£ãŸã®ã§ã€æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰é–‹å§‹ã‚’å¾…ã¤
        draftCards.innerHTML = '';
    }
    });


    socket.on('roundStarted', data => {
      currentPhase = 'play';
      hasPlayedThisRound = false;
      hasVotedThisRound = false;
      myVotedSubmissionId = null;

      draftSection.style.display = 'none'; // â˜… ãƒ‰ãƒ©ãƒ•ãƒˆUIã‚’éš ã™
      manualHandSection.style.display = 'none'; 

      document.getElementById('prompt-section').style.display = 'block';

        // â˜… æ¬¡ãƒ©ã‚¦ãƒ³ãƒ‰ãƒœã‚¿ãƒ³é–¢é€£ã‚’ãƒªã‚»ãƒƒãƒˆ
      nextRoundButton.style.display = 'none';
      nextRoundWait.style.display = 'none';
      

      setPhase(
        `ç¬¬${data.round}ãƒ©ã‚¦ãƒ³ãƒ‰ï¼šå›ç­”é¸æŠ`,
        'æ‰‹æœ­ã‹ã‚‰1æšé¸ã‚“ã§ãã ã•ã„ã€‚',
        `å›ç­”é¸æŠ ${data.round}/${data.totalRounds}`
      );
      promptText.textContent = data.prompt;
      renderScores(data.scores);
      showHand(data.hand);

      resultSection.style.display = 'none';
      gameoverSection.style.display = 'none';
      gameError.textContent = '';
    });

    socket.on('startHandInput', data => {
      currentPhase = 'handInput';
      setPhase(
        'æ‰‹æœ­ä½œæˆ',
        'è‡ªåˆ†ã ã‘ã®å›ç­”ã‚«ãƒ¼ãƒ‰ã‚’5ã¤å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚',
        'æ‰‹æœ­ä½œæˆ'
      );

      manualHandSection.style.display = 'block';
      handSection.style.display = 'none';
      voteSection.style.display = 'none';
      resultSection.style.display = 'none';
      gameoverSection.style.display = 'none';
      document.getElementById('prompt-section').style.display = 'none';

      manualHandMessage.textContent = '';
      submitHandButton.disabled = false;
      manualHandInputs.forEach((ta, idx) => {
        ta.value = '';  // æ¯å›ã‚¯ãƒªã‚¢
        ta.placeholder = `å›ç­”${idx + 1}`;
      });
    });


    socket.on('startVote', data => {
      currentPhase = 'vote';
      hasVotedThisRound = false;
      myVotedSubmissionId = null;

      setPhase(
        `ç¬¬${data.round}ãƒ©ã‚¦ãƒ³ãƒ‰ï¼šæŠ•ç¥¨`,
        'ä¸€ç•ªé¢ç™½ã„ã¨æ€ã†å›ç­”ã«æŠ•ç¥¨ã—ã¦ãã ã•ã„ã€‚ï¼ˆè‡ªåˆ†ã®ã‚«ãƒ¼ãƒ‰ã«ã¯æŠ•ç¥¨ã§ãã¾ã›ã‚“ï¼‰',
        `æŠ•ç¥¨ä¸­ ${data.round}/${data.totalRounds}`
      );
      promptText.textContent = data.prompt;
      renderScores(data.scores);
      showVoteCards(data.submissions);
    });

    socket.on('roundResult', data => {
      currentPhase = 'result';
      renderScores(data.scores);
      showRoundResult(data);
      if (data.isLastRound) {
        setPhase(`ç¬¬${data.round}ãƒ©ã‚¦ãƒ³ãƒ‰çµæœ`, 'ã¾ã‚‚ãªãã‚²ãƒ¼ãƒ çµ‚äº†ã§ã™ã€‚', 'æœ€çµ‚ãƒ©ã‚¦ãƒ³ãƒ‰çµæœ');
      } else {
        setPhase(`ç¬¬${data.round}ãƒ©ã‚¦ãƒ³ãƒ‰çµæœ`, 'ã—ã°ã‚‰ãã™ã‚‹ã¨æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ãŒå§‹ã¾ã‚Šã¾ã™ã€‚', 'ãƒ©ã‚¦ãƒ³ãƒ‰çµæœ');
      }
    });

    socket.on('gameOver', data => {
      currentPhase = 'finished';
      setPhase('ã‚²ãƒ¼ãƒ çµ‚äº†', 'æœ€çµ‚çµæœã‚’ã”ç¢ºèªãã ã•ã„ã€‚', 'ã‚²ãƒ¼ãƒ çµ‚äº†');

      document.getElementById('prompt-section').style.display = 'none';

      showGameOver(data);

      if (myPlayerId && myPlayerId === hostId) {
        restartButton.disabled = false;
      } else {
        restartButton.disabled = true;
      }
    });

    socket.on('cardPlayed', () => {
      hasPlayedThisRound = true;
      const cards = handCards.querySelectorAll('.card');
      cards.forEach(c => c.classList.add('disabled'));
    });

    socket.on('errorMessage', data => {
      if (!data || !data.message) return;
      console.warn('Error from server:', data.message);
      gameError.textContent = data.message;
      if (!myPlayerId) {
        joinError.textContent = data.message;
      }
    });
  </script>
</body>
</html>
